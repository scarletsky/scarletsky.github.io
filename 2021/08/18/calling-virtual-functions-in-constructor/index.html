<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>在构造函数中调用虚函数 - scarletsky</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="scarletsky" /><meta name="description" content="简介 虚函数是指派生类中重新定义的成员函数。如有 A#fromJSON，当 B 继承 A 时并重新定义了 B#fromJSON，这时候 fromJSON 就是一个虚函数了。" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.74.3 with theme even" />


<link rel="canonical" href="https://scarletsky.github.io/2021/08/18/calling-virtual-functions-in-constructor/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.2e81bbed97b8b282c1aeb57488cc71c8d8c8ec559f3931531bd396bf31e0d4dd.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="在构造函数中调用虚函数" />
<meta property="og:description" content="简介 虚函数是指派生类中重新定义的成员函数。如有 A#fromJSON，当 B 继承 A 时并重新定义了 B#fromJSON，这时候 fromJSON 就是一个虚函数了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://scarletsky.github.io/2021/08/18/calling-virtual-functions-in-constructor/" />
<meta property="article:published_time" content="2021-08-18T14:36:13+08:00" />
<meta property="article:modified_time" content="2021-08-19T10:16:00+08:00" />
<meta itemprop="name" content="在构造函数中调用虚函数">
<meta itemprop="description" content="简介 虚函数是指派生类中重新定义的成员函数。如有 A#fromJSON，当 B 继承 A 时并重新定义了 B#fromJSON，这时候 fromJSON 就是一个虚函数了。">
<meta itemprop="datePublished" content="2021-08-18T14:36:13+08:00" />
<meta itemprop="dateModified" content="2021-08-19T10:16:00+08:00" />
<meta itemprop="wordCount" content="1457">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="在构造函数中调用虚函数"/>
<meta name="twitter:description" content="简介 虚函数是指派生类中重新定义的成员函数。如有 A#fromJSON，当 B 继承 A 时并重新定义了 B#fromJSON，这时候 fromJSON 就是一个虚函数了。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">scarletsky.github.io</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">scarletsky.github.io</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">在构造函数中调用虚函数</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-08-18 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#简介">简介</a></li>
<li><a href="#动机">动机</a></li>
<li><a href="#问题">问题</a>
<ul>
<li><a href="#访问未完成实例化的对象">访问未完成实例化的对象</a></li>
<li><a href="#没有正确的调用时机">没有正确的调用时机</a></li>
<li><a href="#容易重复调用实例方法">容易重复调用实例方法</a></li>
</ul></li>
<li><a href="#参考资料">参考资料</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="简介">简介</h2>

<p>虚函数是指派生类中重新定义的成员函数。如有 <code>A#fromJSON</code>，当 B 继承 A 时并重新定义了 <code>B#fromJSON</code>，这时候 <code>fromJSON</code> 就是一个虚函数了。
虚函数在实现多态时非常有用，但在构造函数中调用虚函数却会带来很多问题。
最近在这个问题中碰壁多次，决定写一篇总结。</p>

<h2 id="动机">动机</h2>

<p>最开始我是希望提供两个 API：</p>

<ul>
<li><code>new A(options)</code> 根据传入参数进行实例化</li>
<li><code>A#fromJSON(options)</code> 根据传入参数修改当前实例的属性</li>
</ul>

<p>由于这两个 API 都需要检查输入，并设置当前实例的属性，于是我很自然的就在构造函数中调用了 <code>fromJSON</code> 方法。
这两个 API 最开始还能工作得比较好，但随着我的类之间的依赖变得越来越复杂，这种做法的问题暴露出越来越多的问题。</p>

<h2 id="问题">问题</h2>

<h3 id="访问未完成实例化的对象">访问未完成实例化的对象</h3>

<p>先来看看下面的 typescript 示例代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">class</span> <span class="nx">Color</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="nx">isA</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isA</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">isA</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">isA</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="nx">color</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Color</span><span class="p">();</span>

    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">color</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">new</span> <span class="nx">B</span><span class="p">({</span> <span class="nx">color</span><span class="o">:</span> <span class="p">{</span> <span class="nx">r</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">g</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">b</span>: <span class="kt">1</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
<p>这是很正常的写法，B 继承了 A，然后在初始化的时候去调用 <code>B#fromJSON</code> 去设置自己的属性。
然而当我们运行的时候却会报下面的错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">runtime.ts:178 TypeError: Cannot read property &#39;fromJSON&#39; of undefined
    at B.fromJSON (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:35:24)
    at new A (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:20:14)
    at new B (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:29:9)
    at eval (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:38:1)</code></pre></td></tr></table>
</div>
</div>
<p>初看报错会一脸懵逼，但看一看 build 出来的 javascript 代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">class</span> <span class="nx">Color</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kr">class</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">isA</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Color</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">color</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>可以看到，在 B 的 <code>constructor</code> 里面的 <code>super(...arguments)</code> 里面执行了 <code>this.fromJSON</code>，在这之前 B 的 <code>color</code> 属性还没有初始化，因此在调用 <code>B#fromJSON</code> 的时候就会报错了。
这是一个非常典型的错误， 在 stackoverflow 中的<a href="https://stackoverflow.com/a/5230637/2331095">一篇答案</a>所说的：</p>

<blockquote>
<p>You shouldn&rsquo;t: calling instance method in constructor is dangerous because the object is not yet fully initialized (this applies mainly to methods than can be overridden). Also complex processing in constructor is known to have a negative impact on testability.</p>
</blockquote>

<p>在实例化的过程中调用实例方法是一个非常危险的做法，因为该实例还没有完成初始化流程，在实例化时执行复杂的处理会影响实例的可测试性。</p>

<h3 id="没有正确的调用时机">没有正确的调用时机</h3>

<p>上面的例子中，我们看到了<code>this.fromJSON</code> 的调用时机不正确导致了代码报错，要解决上面例子的报错，只需要调整一下 <code>this.fromJSON</code> 的调用时机即可，也就是说在初始化 <code>color</code> 之后再调用即可。</p>

<p>但这种做法只是适用上面的例子而已，下次再加一个 <code>class C extends B</code> 一样会报类似的错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">class</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="nx">isA</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="nx">color</span>: <span class="kt">Color</span><span class="p">;</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Color</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">C</span> <span class="kr">extends</span> <span class="nx">B</span> <span class="p">{</span>
    <span class="nx">color2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Color</span><span class="p">();</span>
    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">color2</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">color2</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">color2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">new</span> <span class="nx">C</span><span class="p">({</span> <span class="nx">color2</span><span class="o">:</span> <span class="p">{</span> <span class="nx">r</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">g</span>: <span class="kt">0</span><span class="p">,</span> <span class="nx">b</span>: <span class="kt">1</span> <span class="p">}</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">TypeError: Cannot read property &#39;fromJSON&#39; of undefined
    at C.fromJSON (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:46:25)
    at new B (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:30:14)
    at new C (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:40:9)
    at eval (eval at &lt;anonymous&gt; (runtime.ts:154), &lt;anonymous&gt;:49:1)</code></pre></td></tr></table>
</div>
</div>
<p>看吧，同样的报错。</p>

<h3 id="容易重复调用实例方法">容易重复调用实例方法</h3>

<p>当我们希望基类及其派生类都有同样的行为时，我们很自然的会往基类的构造函数中调用一些实例方法。但当我们一不留神的时候，很容易会重复调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">class</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">A</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Checking prop A&#39;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;I am in A&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Checking prop B&#39;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;I am in B&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">C</span> <span class="kr">extends</span> <span class="nx">B</span> <span class="p">{</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">C</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Checking prop C&#39;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;I am in C&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">new</span> <span class="nx">C</span><span class="p">({</span> <span class="nx">A</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">B</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">C</span>: <span class="kt">1</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">[LOG]: &#34;Checking prop A&#34; 
[LOG]: &#34;I am in A&#34; 
[LOG]: &#34;Checking prop B&#34; 
[LOG]: &#34;I am in B&#34; 
[LOG]: &#34;Checking prop C&#34; 
[LOG]: &#34;I am in C&#34; 
[LOG]: &#34;Checking prop A&#34; 
[LOG]: &#34;I am in A&#34; 
[LOG]: &#34;Checking prop B&#34; 
[LOG]: &#34;I am in B&#34; 
[LOG]: &#34;Checking prop C&#34; 
[LOG]: &#34;I am in C&#34; </code></pre></td></tr></table>
</div>
</div>
<p>这是由于我们在 <code>C</code> 的 <code>constructor</code> 中也调用了一次 <code>this.fromJSON</code>，换句话说，如果我们不清楚父级的 <code>constructor</code> 实现的话，就会很容易发生类似的事情。</p>

<p>但有没有什么优雅的做法去解决这一类问题呢？ 很遗憾，并没有。</p>

<p>最好的解决办法是不要在构造函数中调用虚函数。</p>

<h2 id="参考资料">参考资料</h2>

<ul>
<li><a href="https://docs.microsoft.com/zh-cn/cpp/cpp/virtual-functions?view=msvc-160">虚函数</a></li>
<li><a href="https://stackoverflow.com/questions/962132/calling-virtual-functions-inside-constructors">Calling virtual functions inside constructors</a></li>
<li><a href="https://stackoverflow.com/questions/5230565/can-i-call-methods-in-constructor-in-java">Can I call methods in constructor in Java</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">scarletsky</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-08-19
        <a href="/commit/4c89e560c0aa1ebc8814d04d77443000824364eb" title="feat: add calling virtual functions in constructor">(4c89e56)</a>
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        
        <a class="next" href="/2021/03/06/gl-depth-transformation/">
            <span class="next-text nav-default">深度变换总结</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="scarletsky/scarletsky.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:scarletsky1025@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/scarletsky" class="iconfont icon-github" title="github"></a>
  <a href="https://scarletsky.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>scarletsky</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
